# 需求迭代文档

## 项目结构

```
findSameVideo/
├── main.py                 # 应用入口
├── gui.py                  # PyQt6 图形界面
├── file_scanner.py         # 文件扫描和哈希计算
├── duplicate_finder.py     # 重复检测核心逻辑
├── cache_manager.py        # 哈希缓存管理
├── export_manager.py       # 报告导出功能
├── config_manager.py       # 配置文件管理
├── logger.py               # 日志系统
├── requirements.txt        # 依赖列表
├── CLAUDE.md              # 开发指南
└── ROADMAP.md             # 本文档
```

## 优先级定义

- **P0 - 高优先级**：核心功能改进，显著提升用户体验或安全性
- **P1 - 中优先级**：性能优化或重要功能增强
- **P2 - 低优先级**：体验优化或高级功能

---

## P0 - 高优先级

### ✅ 1. 智能选择策略
**状态**：✅ 已完成
**描述**：自动选择要删除的重复文件，减少手动操作
**功能点**：
- [x] 保留路径最短的文件
- [x] 保留最新/最旧的文件（基于修改时间）
- [x] 保留路径最长的文件
- [x] 保留最大/最小的文件
- [x] 按路径模式选择（正则表达式）
- [x] "在每组中保留一个"快捷按钮
- [x] 全选/不选按钮
- [x] 预览将要删除的文件数量和空间

**实现**：
- `SmartSelectDialog` 类：智能选择对话框
- 支持多种选择策略
- 显示统计信息和确认对话框

---

### ✅ 2. 安全删除（回收站）
**状态**：✅ 已完成
**描述**：删除文件时移动到回收站而非永久删除，支持撤销
**功能点**：
- [x] 使用 `send2trash` 库移动到回收站
- [x] 记录删除历史（保存到 `deletion_history.json`）
- [x] 显示删除操作的结果
- [x] 显示删除预览（前10个文件）
- [x] 计算并显示释放的空间

**依赖**：`send2trash==1.8.2`

---

## P1 - 中优先级

### ✅ 3. 并行哈希计算
**状态**：✅ 已完成
**描述**：使用多线程并行计算哈希，提升大文件扫描速度
**功能点**：
- [x] 使用 `concurrent.futures.ThreadPoolExecutor` 实现并行
- [x] 根据CPU核心数动态分配线程（最多8个）
- [x] 保持进度回调功能
- [x] 支持取消操作

**性能预期**：
- 多核 CPU 下速度提升 2-4 倍
- 尤其对大视频文件效果明显

---

### ✅ 4. 缓存机制
**状态**：✅ 已完成
**描述**：缓存文件哈希结果，大幅提升重复扫描速度
**功能点**：
- [x] 使用 SQLite 存储哈希缓存（`hash_cache.db`）
- [x] 基于文件修改时间和大小判断缓存有效性
- [x] 批量保存缓存提高性能
- [x] 缓存统计功能（命中率、缓存条目数等）

**技术方案**：
- `cache_manager.py` 模块
- 数据库表：`(path, size, mtime, hash_value, created_at, updated_at)`
- 扫描前查询缓存，只计算变更文件的哈希

---

### ✅ 5. 导出功能
**状态**：✅ 已完成
**描述**：导出扫描报告，方便数据分享和存档
**功能点**：
- [x] 导出为 CSV 格式（支持 Excel 打开）
- [x] 导出为 JSON 格式（用于程序处理）
- [x] 导出为 HTML 报告（含图表和样式）
- [x] 可选择是否包含完整元数据
- [x] 自动生成带时间戳的文件名

**实现**：
- `export_manager.py` 模块
- `ExportDialog` 对话框
- HTML 报告包含交互式界面和统计图表

---

### ✅ 6. 多阶段哈希策略
**状态**：✅ 已完成
**描述**：先计算部分哈希快速筛选，再计算完整哈希确认
**功能点**：
- [x] 第一阶段：计算文件头部+尾部+中间各 1MB
- [x] 第二阶段：只对部分哈希匹配的文件计算完整哈希
- [x] 自动判断是否使用多阶段策略（10个以上大文件）
- [x] 与缓存机制协同工作

**性能优化**：
- 对大文件（>5MB）启用多阶段哈希
- 大幅减少完整哈希计算次数
- 进度报告包含两阶段

---

### ✅ 7. 批量操作增强
**状态**：✅ 已完成
**描述**：增强批量选择功能
**功能点**：
- [x] 全选/不选按钮
- [x] 反选按钮
- [x] 按目录选择/取消选择
- [x] 按大小范围选择/取消选择
- [x] 高级选择对话框

**实现**：
- `AdvancedSelectDialog` 类
- 支持按目录路径筛选
- 支持按文件大小范围筛选

---

## P2 - 低优先级

### ✅ 8. 深色模式
**状态**：✅ 已完成
**描述**：支持深色主题，适配系统主题
**功能点**：
- [x] 菜单栏添加主题切换选项
- [x] 完整的浅色/深色样式表
- [x] 一键切换主题
- [x] 状态栏提示当前模式

**实现**：
- `ThemeManager` 类管理样式表
- 完整的 PyQt6 样式定义
- 覆盖所有 UI 组件

---

### ✅ 9. 预计剩余时间
**状态**：✅ 已完成
**描述**：显示扫描预计剩余时间
**功能点**：
- [x] 计算扫描速度
- [x] 估算剩余时间
- [x] 动态更新显示
- [x] 智能时间格式化（秒/分/小时）

---

### ✅ 10. 拖拽支持
**状态**：✅ 已完成
**描述**：支持拖拽文件夹到窗口开始扫描
**功能点**：
- [x] 实现 `dragEnterEvent` 和 `dropEvent`
- [x] 支持多文件夹拖拽
- [x] 拖拽自动开始扫描

---

### ✅ 11. 搜索和过滤
**状态**：✅ 已完成
**描述**：在结果中搜索和过滤
**功能点**：
- [x] 按文件名/路径搜索
- [x] 实时过滤结果
- [x] 显示过滤后结果数量
- [x] 清除搜索按钮

---

### ✅ 12. 相似文件检测
**状态**：✅ 已完成
**描述**：检测近似相似的图片和视频
**功能点**：
- [x] 图片相似度检测（使用 ImageHash）
- [x] 视频关键帧相似度检测
- [x] 用户可设置相似度阈值
- [x] 显示相似度百分比
- [x] 多种哈希算法支持（感知哈希、平均哈希、差异哈希、小波哈希）
- [x] 分别检测图片和视频
- [x] 彩色编码相似度结果

**依赖**：`Pillow==10.4.0`, `imagehash==4.3.1`, `opencv-python==4.9.0.80`

**实现**：
- `similarity_detector.py` 模块
- `SimilarityDetector` 类
- `SimilarityDialog` 设置对话框
- `SimilarityResultsDialog` 结果显示对话框

---

### ✅ 13. 文件预览
**状态**：✅ 已完成
**描述**：预览选中文件的缩略图和元信息
**功能点**：
- [x] 侧边栏显示缩略图
- [x] 显示文件元信息（分辨率、时长等）
- [x] 快速预览文件内容

**实现**：
- 预览面板集成到主界面
- 自动加载图片缩略图
- 显示文件详细信息

---

## 代码质量改进

### ✅ 14. 日志系统
**状态**：✅ 已完成
**描述**：添加完整的日志系统
**功能点**：
- [x] 使用 Python logging 模块
- [x] 记录扫描过程、错误信息
- [x] 可配置日志级别
- [x] 日志文件轮转（10MB/文件，最多5个备份）
- [x] 单独的错误日志文件

**实现**：
- `logger.py` 模块
- 日志文件保存在 `~/.findSameVideo/logs/`
- 支持控制台和文件双输出

---

### ✅ 15. 配置文件
**状态**：✅ 已完成
**描述**：支持配置文件
**功能点**：
- [x] JSON 配置文件
- [x] 默认扩展名配置
- [x] 主题配置
- [x] 缓存配置
- [x] 窗口大小记忆

**实现**：
- `config_manager.py` 模块
- 配置文件保存在 `~/.findSameVideo/config.json`
- 应用关闭时自动保存配置

---

### ✅ 16. 命令行模式
**状态**：✅ 已完成
**描述**：支持 CLI 模式用于自动化
**功能点**：
- [x] `--scan` 扫描目录
- [x] `--export` 导出报告
- [x] `--delete` 自动删除
- [x] `--help` 帮助信息
- [x] 支持文件扩展名过滤
- [x] 详细输出模式
- [x] 进度显示
- [x] 并行/缓存/多阶段哈希选项

**实现**：
- `DuplicateFinderCLI` 类
- 支持的命令：
  - `scan`: 扫描目录查找重复文件
  - `export`: 扫描并导出报告
- 使用示例：
  ```bash
  python main.py scan ~/Pictures
  python main.py scan ~/Documents -v --delete
  python main.py export ~/Downloads -f html -o report.html
  ```

---

### 📋 17. 单元测试
**状态**：待实现
**描述**：添加单元测试
**功能点**：
- [ ] 测试哈希计算
- [ ] 测试重复检测逻辑
- [ ] 测试边界条件
- [ ] CI/CD 集成

---

## 安全性改进

### ✅ 18. 删除确认增强
**状态**：✅ 已完成（随安全删除功能实现）
**描述**：增强删除确认对话框
**功能点**：
- [x] 显示将被删除的前 N 个文件
- [x] 显示删除模式（回收站/永久删除）
- [x] 计算并显示将要释放的空间

---

### ✅ 19. 权限检查
**状态**：✅ 已完成
**描述**：扫描前检查权限
**功能点**：
- [x] 预检查目录读取权限
- [x] 显示无权限目录列表
- [x] 跳过无权限目录

**实现**：
- `file_scanner.py` 中的权限检查方法
- 扫描时自动处理权限错误
- 显示权限警告对话框

---

## 图例说明

- ✅ 已完成
- ⏳ 进行中
- 📋 待开始
- ⚠️ 有问题
- ❌ 已取消

---

## 版本历史

### v0.6.0（当前版本）
- ✅ 命令行模式（CLI）
  - `scan` 命令扫描目录查找重复文件
  - `export` 命令导出扫描报告
  - 支持文件扩展名过滤
  - 详细输出模式
  - 自动删除选项（`--delete`）
  - 性能选项（并行、缓存、多阶段哈希）

### v0.5.0
- ✅ 相似文件检测功能
  - 图片相似度检测（使用感知哈希算法）
  - 视频关键帧相似度检测
  - 可配置相似度阈值（0-100%）
  - 多种哈希算法支持
  - 彩色编码结果显示
- ✅ 权限检查功能
  - 预检查目录权限
  - 跳过无权限目录
  - 显示权限错误摘要
- ✅ 文件预览功能
  - 图片缩略图预览
  - 文件元信息显示
  - 自动调整缩略图大小

### v0.4.0
- ✅ 预计剩余时间显示
- ✅ 拖拽支持（拖拽文件夹自动扫描）
- ✅ 搜索和过滤功能
- ✅ 配置文件支持
- ✅ 日志系统

### v0.3.0
- ✅ 多阶段哈希策略
- ✅ 批量操作增强（反选、按目录/大小选择）
- ✅ 深色模式支持

### v0.2.0
- ✅ 智能选择策略
- ✅ 安全删除（回收站）
- ✅ 并行哈希计算
- ✅ 缓存机制
- ✅ 导出功能

### v0.1.0（初始版本）
- 基本的文件扫描功能
- 重复文件检测
- 手动选择和删除

---

## 功能特性总结

### 性能优化
- **多线程哈希计算**：利用多核 CPU 加速哈希计算，2-4倍性能提升
- **多阶段哈希策略**：先部分哈希筛选，再完整哈希确认
- **缓存机制**：SQLite 缓存哈希结果，大幅提升重复扫描速度

### 用户体验
- **智能选择**：多种策略自动选择要删除的文件
- **安全删除**：移至回收站而非永久删除
- **批量操作**：全选、反选、按目录/大小选择
- **导出功能**：支持 CSV、JSON、HTML 格式报告
- **深色模式**：完整的主题切换支持
- **预计剩余时间**：实时显示扫描进度和预计完成时间
- **拖拽支持**：拖拽文件夹即可开始扫描
- **搜索过滤**：实时搜索和过滤结果

### 数据安全
- **删除历史记录**：保存删除操作历史
- **删除预览**：显示将被删除的文件列表
- **回收站支持**：误删可恢复

### 可维护性
- **日志系统**：完整的日志记录，便于调试和问题排查
- **配置文件**：持久化用户设置，自动恢复
- **模块化设计**：清晰的模块划分，易于维护和扩展

---

## 数据文件位置

### 用户目录
```
~/.findSameVideo/
├── config.json           # 用户配置
├── deletion_history.json # 删除历史
├── hash_cache.db         # 哈希缓存
└── logs/                 # 日志目录
    ├── findSameVideo_YYYYMMDD.log  # 按日期的日志
    └── errors.log         # 错误日志
```

### 工作目录
```
findSameVideo/
├── main.py
├── gui.py
├── ...
├── hash_cache.db         # 运行时生成（缓存）
└── deletion_history.json # 运行时生成
```
